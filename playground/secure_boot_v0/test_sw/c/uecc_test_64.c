#include <stdint.h>
#include <stdbool.h>

#include "./utils/uart.h"
#include "./utils/micro-ecc/uECC.h"

static void uart_puts(const char *s) {
  while (*s) {
    uart_putc(*s++);
  }
}

static void uart_put_hex8(uint8_t v) {
  const uint8_t hi = (v >> 4) & 0xF;
  const uint8_t lo = v & 0xF;
  uart_putc((hi < 10) ? ('0' + hi) : ('A' + (hi - 10)));
  uart_putc((lo < 10) ? ('0' + lo) : ('A' + (lo - 10)));
}

static void uart_put_bytes(const uint8_t *buf, unsigned len) {
  for (unsigned i = 0; i < len; ++i) {
    uart_put_hex8(buf[i]);
  }
}

static void die(const char *msg) {
  uart_puts("FAIL: ");
  uart_puts(msg);
  uart_putc('\n');
  while (1) {
    __asm__ volatile("wfi");
  }
}

static uint32_t rng_state = 0x1u;

static uint32_t xorshift32(void) {
  uint32_t x = rng_state;
  x ^= x << 13;
  x ^= x >> 17;
  x ^= x << 5;
  rng_state = x;
  return x;
}

// Deterministic RNG for micro-ecc (good enough for self-test only)
static int uecc_rng(uint8_t *dest, unsigned size) {
  for (unsigned i = 0; i < size; ++i) {
    dest[i] = (uint8_t)(xorshift32() & 0xFF);
  }
  return 1;  // success
}

int main(void) {
  const struct uECC_Curve_t *curve = uECC_secp160r1();

  // Known-good test vector (secp160r1, message = 0x01..0x40)
  static const uint8_t pub[40] = {
    0x42,0xE2,0xA8,0x0A,0xC8,0x8D,0xFB,0x6C,
    0x42,0x41,0x43,0x3F,0xF4,0xB7,0x5A,0x8E,
    0x4A,0xDB,0xDC,0xB6,0x42,0x43,0xAE,0x1C,
    0x2A,0x3F,0x70,0xD1,0x4A,0xFB,0x60,0x34,
    0x19,0x53,0xA5,0x7D,0x42,0x88,0x89,0xC9,
  };

  static const uint8_t msg[64] = {
    0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08,
    0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,
    0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,
    0x19,0x1A,0x1B,0x1C,0x1D,0x1E,0x1F,0x20,
    0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,
    0x29,0x2A,0x2B,0x2C,0x2D,0x2E,0x2F,0x30,
    0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,
    0x39,0x3A,0x3B,0x3C,0x3D,0x3E,0x3F,0x40,
  };

  // r||s signature for the above msg with the above pubkey (P-160)
  static const uint8_t sig[40] = {
    0x08,0x91,0x4A,0xE6,0x56,0xDA,0xBF,0x33,
    0x98,0xB0,0x5B,0x99,0xFD,0x3D,0x36,0xDF,
    0x7F,0xE4,0x0E,0x2F,0xC5,0xB0,0xDE,0x7B,
    0xD7,0xC2,0xA9,0xC0,0x76,0xA2,0x39,0x33,
    0x9E,0x71,0x1D,0x94,0x67,0x8D,0x27,0x45,
  };

  uart_putc('s');

  if (!uECC_verify(pub, msg, sizeof(msg), sig, curve)) {
    die("verify");
  }

  uart_putc('V');

  while (1) {
    __asm__ volatile("wfi");
  }
}
